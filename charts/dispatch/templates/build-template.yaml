apiVersion: build.knative.dev/v1alpha1
kind: BuildTemplate
metadata:
  name: function-template
  namespace: {{ .Release.Namespace }}
spec:
  parameters:
  - name: DESTINATION_IMAGE
    description: The destination to push the image (image name)
  - name: SOURCE_IMAGE
    description: The image which this function image is built from
  - name: HANDLER
    description: The fully-qualified function implementation name
  - name: DOCKERFILE
    description: Path to the Dockerfile to build
    default: Dockerfile
  steps:
  - name: fetch-function-dockerfile
    image: ${SOURCE_IMAGE}
    command: ['cp']
    args: ['/function-template/Dockerfile', '/workspace']
  - name: build-and-push
    # Pinned to a pre-latest tag... latest/v0.1.0 has issues finding the Dockerfile
    image: gcr.io/kaniko-project/executor:ae39c0fa8b63cea2e1d73118eae60dc29797f397
    args:
    - --dockerfile=${DOCKERFILE}
    - --destination=${DESTINATION_IMAGE}
    #- --insecure-skip-tls-verify (not yet implemented)
    - --build-arg=IMAGE=${SOURCE_IMAGE}
    - --build-arg=HANDLER=${HANDLER}